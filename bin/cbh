#!/bin/bash
DONGLE_FILE="$HOME/.comma-body-dongle"
REMOTE_TOOL_URL="https://raw.githubusercontent.com/kfatehi/comma-body-hacks/master/payloads/remote-tool.sh"
if [ ! -t 0 ] ; then
    echo "Not an interactive shell. Cannot present you with the interface. Goodbye."
    exit 1
fi
case $1 in
    set-dongle)
    shift
    if [[ "$1" == "" ]]; then
        echo "error: please enter a dongle id."
        exit 1
    fi
    echo $1 > $DONGLE_FILE
    ;;
    *)
    if [[ ! -f $DONGLE_FILE || "$(cat $DONGLE_FILE)" == "" ]]; then
        echo "Please use set-dongle first or add your dongle id manually to $DONGLE_FILE"
    fi
    SSH_TARGET="comma@$(cat $DONGLE_FILE)"
    ssh -t -o ProxyCommand="ssh -W %h:%p -p %p %h@ssh.comma.ai" $SSH_TARGET tmux new-session -A -s body "sudo bash -c '. <(curl -sSL $REMOTE_TOOL_URL)'"
    ;; 
esac